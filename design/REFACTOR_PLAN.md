# AutoDoor UI 重构方案

## 一、重构目标

将现有的 Tkinter UI 迁移到 CustomTkinter 框架，实现现代化界面设计，同时保证：
- Windows 和 macOS 双端兼容性
- 所有原有功能正常运行
- 代码结构清晰，易于维护

---

## 二、重构范围

### 2.1 需要修改的文件

| 文件路径 | 修改类型 | 说明 |
|---------|---------|------|
| `autodoor.py` | 重构 | 主程序入口，UI初始化逻辑 |
| `ui/styles.py` | 重写 | 样式配置，适配CustomTkinter |
| `ui/home.py` | 重写 | 首页标签页 |
| `ui/ocr_tab.py` | 重写 | 文字识别标签页 |
| `ui/timed_tab.py` | 重写 | 定时功能标签页 |
| `ui/number_tab.py` | 重写 | 数字识别标签页 |
| `ui/script_tab.py` | 重写 | 脚本运行标签页 |
| `ui/basic_tab.py` | 重写 | 基本设置标签页 |
| `ui/builder.py` | 重写 | UI构建器 |
| `ui/utils.py` | 修改 | UI工具函数，适配新组件 |
| `ui/validators.py` | 保留 | 输入验证器，无需修改 |
| `requirements.txt` | 修改 | 添加customtkinter依赖 |

### 2.2 新增文件

| 文件路径 | 说明 |
|---------|------|
| `ui/theme.py` | 主题配置，颜色、字体、尺寸定义 |
| `ui/widgets.py` | 自定义组件（CardFrame、AnimatedButton、NumericEntry等） |

### 2.3 不需要修改的文件

- `core/` 目录下所有文件
- `modules/` 目录下所有文件
- `input/` 目录下所有文件
- `utils/` 目录下所有文件

---

## 三、重构步骤

### 阶段一：基础框架搭建

#### 步骤 1.1：添加依赖
- 在 `requirements.txt` 中添加 `customtkinter>=5.2.0`
- 更新安装脚本

#### 步骤 1.2：创建主题配置
- 创建 `ui/theme.py`
- 定义颜色常量、字体配置、尺寸配置
- 实现主题初始化函数

#### 步骤 1.3：创建自定义组件
- 创建 `ui/widgets.py`
- 实现 `CardFrame`（卡片容器）
- 实现 `AnimatedButton`（动画按钮）
- 实现 `NumericEntry`（数字输入框）
- 实现 `LoadingOverlay`（加载遮罩）

### 阶段二：主程序重构

#### 步骤 2.1：修改主程序入口
- 修改 `autodoor.py` 中的 `_init_ui()` 方法
- 替换 `tk.Tk()` 为 `ctk.CTk()`
- 重构 `create_widgets()` 方法
- 实现新的布局结构（侧边栏导航 + 内容区）

#### 步骤 2.2：实现导航系统
- 创建侧边栏导航组件
- 实现页面切换逻辑
- 保持原有的标签页功能映射

### 阶段三：标签页重构

#### 步骤 3.1：重构首页 (ui/home.py)
- 功能状态卡片
- 启动/停止按钮
- 运行日志显示
- 模块指示灯

#### 步骤 3.2：重构文字识别页 (ui/ocr_tab.py)
- OCR识别组管理
- 动态添加/删除功能组
- 区域选择功能
- 配置项输入控件

#### 步骤 3.3：重构定时功能页 (ui/timed_tab.py)
- 定时任务组管理
- 配置项输入控件
- 位置选择功能

#### 步骤 3.4：重构数字识别页 (ui/number_tab.py)
- 数字识别区域管理
- 阈值配置
- 区域选择功能

#### 步骤 3.5：重构脚本运行页 (ui/script_tab.py)
- 命令输入区域
- 脚本编辑器
- 颜色识别配置
- 脚本控制按钮

#### 步骤 3.6：重构基本设置页 (ui/basic_tab.py)
- Tesseract配置
- 报警设置
- 快捷键配置
- 配置管理按钮

### 阶段四：功能对接

#### 步骤 4.1：连接UI与业务逻辑
- 保持原有的代理类接口
- 连接按钮事件到原有方法
- 确保配置加载/保存正常工作

#### 步骤 4.2：区域选择功能适配
- 修改 `utils/region.py` 中的区域选择逻辑
- 适配新的UI组件
- 保持多显示器支持

#### 步骤 4.3：按键捕获功能适配
- 修改按键设置弹窗
- 保持原有的按键监听逻辑

### 阶段五：测试与优化

#### 步骤 5.1：功能测试
- 测试所有模块的启动/停止
- 测试配置保存/加载
- 测试区域选择功能
- 测试按键捕获功能

#### 步骤 5.2：跨平台测试
- Windows 平台测试
- macOS 平台测试
- 权限管理测试

#### 步骤 5.3：性能优化
- 启动速度优化
- 内存使用优化
- UI响应速度优化

---

## 四、技术方案

### 4.1 布局结构

```
┌─────────────────────────────────────────────────────────────┐
│  Header (标题栏 + 状态 + 工具按钮)                           │
├──────────┬──────────────────────────────────────────────────┤
│          │                                                  │
│  Sidebar │              Content Area                        │
│  (导航栏) │              (内容区域)                          │
│          │                                                  │
│  首页     │    ┌─────────────────────────────────────┐      │
│  文字识别 │    │  功能组卡片                          │      │
│  定时功能 │    │  ┌─────────────────────────────┐    │      │
│  数字识别 │    │  │ 标题 + 开关 + 删除按钮      │    │      │
│  脚本运行 │    │  ├─────────────────────────────┤    │      │
│  基本设置 │    │  │ 配置项输入控件              │    │      │
│          │    │  └─────────────────────────────┘    │      │
│          │    └─────────────────────────────────────┘      │
├──────────┴──────────────────────────────────────────────────┤
│  Footer (版权信息)                                           │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 组件映射

| 原Tkinter组件 | 新CustomTkinter组件 | 说明 |
|--------------|---------------------|------|
| `tk.Tk()` | `ctk.CTk()` | 主窗口 |
| `ttk.Frame()` | `ctk.CTkFrame()` / `CardFrame` | 容器 |
| `ttk.Label()` | `ctk.CTkLabel()` | 标签 |
| `ttk.Button()` | `ctk.CTkButton()` / `AnimatedButton` | 按钮 |
| `ttk.Entry()` | `ctk.CTkEntry()` / `NumericEntry` | 输入框 |
| `ttk.Checkbutton()` | `ctk.CTkSwitch()` | 开关 |
| `ttk.Combobox()` | `ctk.CTkOptionMenu()` | 下拉菜单 |
| `ttk.Notebook()` | 自定义导航系统 | 标签页 |
| `tk.Text()` | `ctk.CTkTextbox()` | 文本框 |
| `tk.Scrollbar()` | 内置滚动 | 滚动条 |

### 4.3 变量绑定

保持使用 `tk.StringVar`、`tk.BooleanVar`、`tk.IntVar` 等，CustomTkinter 完全兼容。

### 4.4 事件处理

保持原有的事件处理逻辑，仅需调整绑定方式：
- `command` 参数直接传递回调函数
- `bind()` 方法用于键盘/鼠标事件

---

## 五、兼容性保证

### 5.1 Windows 平台

- DPI 感知设置
- 高对比度模式支持
- 原有功能完全兼容

### 5.2 macOS 平台

- 权限管理保持不变
- 深色模式自动适配
- 原有功能完全兼容

### 5.3 配置文件兼容

- 保持原有 JSON 配置格式
- 配置迁移自动处理
- 向后兼容旧版本配置

---

## 六、风险评估

### 6.1 潜在问题

| 风险 | 影响 | 解决方案 |
|-----|------|---------|
| CustomTkinter版本兼容性 | 中 | 锁定依赖版本，测试多个版本 |
| 区域选择功能适配 | 高 | 保持原有逻辑，仅修改UI触发方式 |
| 按键监听冲突 | 中 | 测试全局快捷键功能 |
| 性能下降 | 低 | 优化渲染，减少重绘 |

### 6.2 回滚方案

- 保留原有 `ui/` 目录为 `ui_legacy/`
- 通过配置切换UI版本
- Git分支管理，随时可回滚

---

## 七、时间规划

| 阶段 | 预计时间 | 任务 |
|-----|---------|------|
| 阶段一 | 1天 | 基础框架搭建 |
| 阶段二 | 1天 | 主程序重构 |
| 阶段三 | 2天 | 标签页重构 |
| 阶段四 | 1天 | 功能对接 |
| 阶段五 | 1天 | 测试与优化 |

**总计：约6天**

---

## 八、验收标准

### 8.1 功能验收

- [ ] 所有原有功能正常运行
- [ ] 配置文件正确读写
- [ ] 区域选择功能正常
- [ ] 按键捕获功能正常
- [ ] 快捷键功能正常
- [ ] 报警功能正常

### 8.2 UI验收

- [ ] 界面美观，符合设计规范
- [ ] 布局合理，信息层次清晰
- [ ] 交互流畅，响应及时
- [ ] 动画效果自然

### 8.3 兼容性验收

- [ ] Windows 10/11 正常运行
- [ ] macOS 11+ 正常运行
- [ ] 深色/浅色模式正常切换
- [ ] 多显示器环境正常

---

## 九、附录

### A. 文件修改清单

详见第二节"重构范围"

### B. 组件API对照表

详见第四节"技术方案"

### C. 测试用例

待补充

---

**文档版本**: 1.0
**创建日期**: 2024-01-15
**最后更新**: 2024-01-15
